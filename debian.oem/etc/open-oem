#!/bin/bash

. debian/debian.env
changelog=${DEBIAN}/changelog

series=$(dpkg-parsechangelog -l "${changelog}" -S Distribution)
if [ "${series}" = "UNRELEASED" ] ; then
	echo "Series is UNRELEASED" >&2
	exit 1
fi

name=$(dpkg-parsechangelog -l "${changelog}" -S Source)
version=$(dpkg-parsechangelog -l "${changelog}" -S Version)

upload=$(echo "${version}" | grep -oP '\d+$')
new_version=${version%"${upload}"}$((upload + 1))

cat <<EOF > "${changelog}".new
${name} (${new_version}) UNRELEASED; urgency=medium

  CHANGELOG: Do not edit directly. Autogenerated at release.
  CHANGELOG: Use the printchanges target to see the curent changes.
  CHANGELOG: Use the insertchanges target to create the final log.

 -- $(git config --get user.name) <$(git config --get user.email)>  $(date -R)

$(cat "${changelog}")
EOF

mv "${changelog}".new "${changelog}"

git add "${changelog}"
git commit -s -F debian/commit-templates/newrelease
